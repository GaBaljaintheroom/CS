### 장치 컨트롤러

- 입출력장치는 CPU, 메모리보다 다루기가 더 까다로움
    - 입쳘력장치에는 종류가 너무나도 많기 떄문
    - 일반적으로 CPU와 메모리의 데이터 전송률은 높지만 입출력장치의 데이터 전송률은 낮음
        - 전송률 : 데이터를 얼마나 빨리 교환할 수 있는지 나타내는 지표
- 장치컨트롤러는 입출력 제어기, 입출력 모듈이라고도 불름
- 모든 입출력장치는 각자의 장치 컨트롤러를 통해 컴퓨터 내부와 정보를 주고받고, 장치 컨트롤러는 하나 이상의 입출력장치와 연결되어 있음
- 역할
    - CPU와 입출력장치 간의 통신 중개
    - 오류 검출
    - 데이터 버퍼링
        - 버퍼에 데이터를 조금씩 모았다가 한꺼번에 내보내거나, 데이터를 한 번에 많이 받아 조금씩 내보내는 방법
- 내부 구조
    - 데이터 레지스터
        - CPU와 입출력장치 사이에 주고받을 데이터가 담기는 레지스터
        - 버퍼 역할
        - 최근에는 RAM을 사용하기도 함
    - 상태 레지스터
        - 입출력장치가 입출력 작업을 할 준비가 되었는지, 입출력 작업이 완료되었는지, 입출력장치에 오류는 없는지 등에 상태 정보가 저장됨
    - 제어 레지스터
        - 입출력장치가 수행할 내용에 대한 제어 정보와 명령을 저장

### 장치 드라이버

- 새로운 장치를 컴퓨터에 연결하려면 장치 드라이버를 설치해야함
- 장치 컨트롤러의 동작을 감지하고 제어함으로써 장치 컨트롤러가 컴퓨터 내부와 정보를 주고받을 수 있게 하는 프로그램
- 장치 컨트롤러가 입출력장치를 연결하기 위한 하드웨어적인 통로라면, 장치 드라이버는 입출력장치를 연결하기 위한 소프트웨어적인 통로
- 장치 드라이버를 인식하고 실행하는 주체는 운영체제

### 프로그램 입출력

- 프로그램 속 명령어로 입출력장치를 제어하는 방법
- CPU가 프로그램 속 명령어를 실행하는 과정에서 입출력 명령어를 만나면 CPU는 입출력장치에 연결된 장치 컨트롤러와 상호작용하며 입출력 작업을 수행
- CPU의 입출력 제어 방법
    - 메모리 맵 입출력

      ![image.png]()

        - 메모리에 접근하기 위한 주소 공간과 입출력장치에 접근하기 위한 주소 공간을 하나의 주소 공간으로 간주하는 방법
        - CPU는 메모리의 주소들이나 장치 컨트롤러의 레지스터들이나 모두 똑같이 메모리 주소를 대하듯 하면 된다는 점
        - 메모리에 접근하는 명령어와 입출력장치에 접근하는 명령어는 굳이 다를 필요가 없음
    - 고립형 입출력

      ![image.png]()

        - 메모리를 위한 주소 공간과 입출력장치를 위한 주소 공간을 분리하는 방법
        - CPU는 입출력장치에 접근하기 위해 메모리에 접근하는 명령어와는 다른(입출력 읽기/쓰기 선을 활성화시키는) 입출력 명렁어를 사용함

| 메모리 맵 입출력 | 고립형 입출력 |
| --- | --- |
| 메모리와 입출력장치는 같은 주소 공간 사용 | 메모리와 입출력장치는 분리된 주소 공간 사용 |
| 메모리 주소 공간이 축소됨 | 메모리 주소 공간이 축소되지 않음 |
| 메모리와 입출력장치에 같은 명령어 사용 가능 | 입출력 전용 명령어 사용 |

### 인터럽트 기반 입출력

- 장치 컨트롤러에 의해 발생
- CPU는 장치 컨트롤러에 입출력 작업을 명령하고, 장치 컨트롤러가 입출력장치를 제어하며 입출력을 수행하는 동안 CPU는 다른 일을 할 수 있음
- 장치 컨트롤러가 입출력 작업을 끝낸 뒤 CPU에게 인터럽트 요청 신호를 보내면 CPU는 하던 일을 잠시 백업하고 인터럽트 서비스 루틴을 실행함
- 동시 다발적인 인터럽트
    1. 인터럽트가 발생한 순서대로 인터럽트를 처리하는 방법 (순차적)

       ![image.png]()

    2. 우선순위가 높은 인터럽트부터 처리하는 방법

       ![image.png]()

    - 플래그 레지스터 속 인터럽트 비트가 활성화되어 있는 경우, 혹은 인터럽트 비트를 비활성화해도 무시할 수 없는 인터럽트인 NMI가 발생한 경우 CPU는 우선순위가 높은 인터럽트부터 처리
    - PIC : 프로그래머 인터럽트 컨트롤러라는 하드웨어로 다중 인터럽트를 처리
        - 여러 장치 컨트롤러에 연결되어 장치 컨트롤러에서 보낸 하드웨어 인터럽트 요청들의 우선순위를 판별한 뒤 CPU에 지금 처리해야할 하드웨어 인터럽트는 무엇인지 알려주는 장치

      ![image.png]()

        - PIC에는 여러 핀이 있는데, 각 핀에는 CPU에 하드웨어 인터럽트 요청을 보낼 수 있는 약속된 하드웨어가 연결되어 있음
        - 동작
            - PIC가 장치 컨트롤러에서 인터럽트 요청 신호를 받아들임
            - PIC는 인터럽트 우선순위를 판단한 뒤 CPU에 처리해야 할 인터럽트 요청 신호를 보냄
            - CPU는 PIC에 인터럽트  확인 신호를 보냄
            - PIC는 데이터 버스를 통해 CPU에 인터럽트 백터를 보냄
            - CPU는 인터럽트 벡터를 통해 인터럽트 요청의 주체를 알게되고, 해당 장치의 인터럽트 서비스 루틴을 실행함
        - PIC는 일반적으로 두 개 이상 계층적으로 구성
        - 무시할 수 없는 인터럽트인 NMI까지 우선순위를 판별하지는 않음.(가장 높아 우선순위 판별이 불필요하기 때문)
        - PIC가 우선순위를 조정해주는 인터럽트는 비트를 통해 막을 수 있는 하드웨어 인터럽트임

### DMA 입출력

- DMA : 입출력장치와 메모리가 CPU를 거치지 않고도 상호작용할 수 있는 입출력 방식

  ![image.png]()

    - 직접 메모리에 접근할 수 있는 입출력 기능
    - DMA 입출력을 하기 위해서는 시스템 버스에 연결된 DMA 컨트롤러라는 하드웨어가 필요함
    - 입출력 과정
        1. CPU는 DMA 컨트롤러에 입출력장치의 주소, 수행할 연산(읽기/쓰기), 읽거나 쓸 메모리의 주소 등과 같은 정보로 입출력 작업을 명령함
        2. DMA 컨트롤러는 CPU 대신 장치 컨트롤러와 상호작용하며 입출력 작업을 수행함. 이때, DMA 컨트롤러는 필요한 경우 메모리에 직접 접근하여 정보를 읽거나 씀
        3. 입출력 작업이 끝나면 DMA 컨트롤러는 CPU에 인터럽트를 걸어 작업이 끝났음을 알림
    - CPU는 DMA 컨트롤러에게 입출력 작업 명령을 내리고, 인터럽트만 받으면 되기 때문에 작업 부담을 훨씬 줄일 수 있음. 죽 CPU는 오로지 입출력의 시작과 끝에만 관여하면 됨
    - 그러나 시스템 버스는 공용 자원이기에 동시 사용이 불가능
        - 따라서 DMA 컨트롤러는 CPU가 시스템 버스를 이용하지 않을 때마다 조금씩 시스템 버스를 이용하거나, CPU가 일시적으로 시스템 버스를 이용하지 않도록 허락을 구하고 시스템 버스를 집중적으로 이용
- 입출력 버스

  ![image.png]()

    - DMA 컨트롤러가 입출력과정 2번에서 메모리에서 DMA 컨트롤러로 데이터를 가져오기 위해 시스템 버스를 한 번 사용하고, DMA 컨트롤러의 데이터를 장치 컨트롤러로 옮기기 위해 시스템 버스를 또 한 번 사용함
    - DMA를 위해 시스템 버스를 너무 자주 사용하면, CPU가 시스템 버스를 이용하지 못함
    - 이 때문에 **입출력 버스**라는 별도의 버스에 연결하여 해결
    - 입출력 버스에는 PCI 버스, PCI Express 버스 등 여러 종류가 있음
    - 따라서 사용하는 거의 모든 입출력장치들은 이렇게 입출력 버스와 연결되는 통로를 통해 시스템 버스를 타고 CPU와 정보를 주고 받음
- 최근에는 입출력 버스 외에 입출력 전용 CPU가 만들어짐 (입출력 프로세서, 입출력 채널이라고 부름)